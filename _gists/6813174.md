---
title: "Simple Librato client for PHP"
date: 2013-10-03
created_at: 2013-10-03T16:59:48Z
updated_at: 2013-10-03T16:59:49Z
---

<strong>LibratoClient.php</strong>

    <?php
    class LibratoClient
    {
        protected $user;

        protected $token;

        protected $metrics;

        public function __construct($user, $token)
        {
            $this->user = $user;
            $this->token = $token;

            $this->resetMetrics();
        }

        public function __destruct()
        {
            $this->flush();
        }

        public function gauge($name, $value, array $opts = [])
        {
            $this->addMetric('gauges', $name, $value, $opts);
        }

        public function count($name, $value, array $opts = [])
        {
            $this->addMetric('counters', $name, $value, $opts);
        }

        public function addMetric($type, $name, $value, array $opts = [])
        {
            $this->metrics[$type][] = array_merge($opts, ['name' => $name, 'value' => $value]);
        }

        // flushes to librato server
        public function flush()
        {
            $ch = curl_init("https://metrics-api.librato.com/v1/metrics");

            curl_setopt($ch, CURLOPT_HTTPHEADER, ["Content-Type: application/json"]);
            curl_setopt($ch, CURLOPT_POST, true);
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($this->metrics));
            curl_setopt($ch, CURLOPT_USERPWD, sprintf("%s:%s", $this->user, $this->token));
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            curl_exec($ch);

            // TODO: $http_status = curl_getinfo($ch, CURLINFO_HTTP_CODE);

            curl_close($ch);

            $this->resetMetrics();
        }

        protected function resetMetrics()
        {
            $this->metrics = ['gauges' => [], 'counters' => []];
        }
    }


[fork or comment at github](https://gist.github.com/6813174)
