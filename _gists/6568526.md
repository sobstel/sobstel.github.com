---
title: "Non-blocking socket connection"
created_at: 2013-09-15T06:41:14Z
updated_at: 2013-09-15T06:42:31Z
---

<strong>nonblock_socket_connect.php</strong>

    <?php
    function nonblock_socket_connect($ip, $port)
    {
        $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);
    
        if (!socket_set_nonblock($socket)) {
            socket_error($socket);
        }
    
        $connected = @socket_connect($socket, $ip, $port);
        if (!$connected) {
            // http://php.net/manual/en/function.socket-connect.php#refsect1-function.socket-connect-returnvalues
            // If the socket is non-blocking then socket_connect() function returns FALSE with an error Operation now in progress.
            $in_progress = (strpos(socket_strerror(socket_last_error()), 'in progress') !== false);
            if (!$in_progress) {
                socket_error($socket);
            }
        }
    
        return $socket;
    }
    
    function socket_error($socket)
    {
        $errno = socket_last_error($socket);
        $errstr = socket_strerror($errno);
    
        throw new Exception($errstr, $errno);
    }


[fork or comment at github](https://gist.github.com/6568526)
